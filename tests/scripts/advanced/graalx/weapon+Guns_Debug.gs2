//#CLIENTSIDE
function onCreated()
{
  this.badanis = {"grab", "pull", "push", "swim"};
  this.CarSeats = {{0.1, -0.6}, {3, 0, 1, 2}, {1.2, -0.6, -2}, {1.2, 0.6, -3}};
}

function onActionClientSide(action, args)
{
  switch (action)
  {
    case "setarch":
    {
      GDBG_TextEdit4.text  = args[0][0];
      GDBG_TextEdit5.text  = args[0][1];
      GDBG_TextEdit6.text  = args[0][2];
      
      GDBG_TextEdit19.text = args[1][0];
      GDBG_TextEdit20.text = args[1][1];
      GDBG_TextEdit17.text = args[1][2];
      GDBG_TextEdit18.text = args[1][3];
      
      GDBG_TextEdit11.text = args[2][0][0];
      GDBG_TextEdit12.text = args[2][0][1];
      GDBG_TextEdit13.text = args[2][1][0];
      GDBG_TextEdit14.text = args[2][1][1];
      GDBG_TextEdit15.text = args[2][2][0];
      GDBG_TextEdit16.text = args[2][2][1];
      
      GDBG_TextEdit.text   = args[3][0];
      GDBG_TextEdit2.text  = args[3][1];
      GDBG_TextEdit1.text  = args[3][2];
      GDBG_TextEdit3.text  = args[3][3];
      
      GDBG_TextEdit7.text  = args[4][0];
      GDBG_TextEdit8.text  = args[4][1];
      GDBG_TextEdit9.text  = args[4][2];
      GDBG_TextEdit10.text = args[4][3];
      
      GDBG_TextEdit21.text = args[5][0];
      GDBG_TextEdit22.text = args[5][1];
      GDBG_TextEdit23.text = args[5][2];
      
      setMudItem();
      
      break;
    }
  }
}

function onWeaponFired()
{
  if (this.gunout <= 0)
  {
    onEquip();
  }
    else
  {
    if (this.burst != 2)
    {
      onFire();
    }
    
    onTimeout();
  }
}

function onTimeout()
{
  if (this.gunout == client.selectedweapon)
  {
    client.ammo = this.muditem.loaded;
    
    if (this.changed == true && (this.muditem.loaded) != this.oldvalue)
    {
      this.changed = false;
    }
    
    if (clientr.car)
    {
      onUnequip();
    }

    if (this.shot <= 0)
    {
      if (player.weapon != "+Guns/Debug" || player.ani == "swim")
      {
        onUnequip();
      }
      
      if (keydown(4))
      {
        if (this.burst == 2)
        {
          onFire();
        }
      }
      
      if (keydown(5))
      {
        onUnequip();
      }
      
      if (keydown(6))
      {
        onReload();
      }
    }
  }
    elseif (this.gunout != -1)
  {
    onUnequip();
  }
    
  if (this.shot > 0) this.shot -= 0.05;
  
  setTimer(0.05);
}

function onKeyPressed(keycode, keychar)
{
  if (this.gunout > 0)
  {
    if (keychar == "F" && this.muditem.dual == false)
    {
      player.chat = "CAN DUEL";
      
     // onDualGuns();
    }
    
    if (keychar == "G")
    {
      onChgBurst();
    }
  }
}

function onDualGuns()
{
  temp.find = player.Mud_FindAllItems("realname", this.muditem.realname);
  player.chat = "Found: " @ temp.find;
}

function onChgBurst()
{
  this.burst++;
  
  while (this.burstmodes[this.burst] == 0)
  {
    if (this.burst == this.burstmodes.size())
    {
      this.burst = 0;
    }
      else
    {
      this.burst++;
    }
  }
}

function onEquip()
{
  this.gunout = client.selectedweapon;
  this.burstmodes = this.muditem.gun[3];
  setani(this.muditem.gun[0] @ "-idle", NULL);
  findWeapon("-Movement").changeAnis(this.muditem.gun[0] @ "-idle", this.muditem.gun[0] @ "-walk", "swim", "push", "pull", "grab", "sit", "sleep", "map");
  onChgBurst();
  this.shot = 0.25;
  
  client.ammo = this.muditem.loaded;
  client.ammomax = this.muditem.gun[2];
  onTimeout();
}

function onFire()
{
  if (this.muditem.loaded > 0)
  {
    if (this.shot <= 0 && clientr.health > 0)
    {
      if (this.burst == 0 || this.burst == 2)
      {
        this.maxbullets = 1;
      }
        else
      {
        if (this.burst == 1)
        {
          this.maxbullets = 3;
          
          if (this.muditem.loaded < this.maxbullets)
          {
            this.maxbullets = this.muditem.loaded;
          }
        }
      }
      
      // Actual Gun Firing
      if (clientr.icar)
      {
      //  player.dir = this.CarSeats[clientr.icar[1]][client.carhold];
        return false;
      }
        elseif (strafedir > -1)
      {
        player.dir = strafedir;
      }
      
      playerfreeze = this.muditem.sfreeze[this.burst][0];
      echo(this.muditem.sfreeze[this.burst][0]);
      this.shot = this.muditem.sfreeze[this.burst][1];
      setani(this.muditem.gun[0] @ "-fire", NULL);

      for (temp.i = 0; temp.i < this.maxbullets; temp.i++)
      {
        this.muditem.loaded--;
        this.angle = getangle(vecx(player.dir), vecy(player.dir)) + random(this.muditem.gunrand[this.burst][0], this.muditem.gunrand[this.burst][1]);
        
        if (player.guild != NULL)
        {
          setshootparams(player.account, this.muditem.damage[this.burst], player.guild, client.nopk, "gun", this.angle, {this.muditem.gunrand[this.burst][0], this.muditem.gunrand[this.burst][1]});
        }
          else
        {
          setshootparams(player.account, this.muditem.damage[this.burst], "(none)", client.nopk, "gun", this.angle, {this.muditem.gunrand[this.burst][0], this.muditem.gunrand[this.burst][1]});
        }
        
        shoot(player.x + this.muditem.gundir[player.dir][0], player.y + this.muditem.gundir[player.dir][1], 0, this.angle, 1, -1, "gx_bullets", NULL);
        sleep(0.01);
      }
      // Above
    }
  }
  else
  {
    onNoLoad();
  }
}

function onNoLoad()
{
  playerfreeze = this.muditem.freeze[2];
  setani(this.muditem.gun[0] @ "-noload", NULL);
  sleep(this.muditem.freeze[3]);
}

function onReload()
{
  if (!contains(this.badanis, player.ani))
  {
    if (this.shot <= 0)
    {
      playerfreeze = this.muditem.freeze[0];
      this.shot = this.muditem.freeze[1];
      setani(this.muditem.gun[0] @ "-reload", NULL);
 
      this.muditem.loaded = this.muditem.gun[2];
    }
  }
}

function onUnequip()
{
  this.burstmodes = -1;
  this.burst = -1;
  this.gunout = -1;
  
  if (player.ani != "swim") setani("idle", NULL);
  
  play("nextpage.wav");
  findWeapon("-Movement").changeAnis3();
  playerfreeze = 0.1;
  setTimer(0);
}

function onCreated()
{
 // if (GDBG_Window0 != NULL) GDBG_Window0.destroy();
  
  temp.types = {"Gani / Arch", "Ammo Max", "Ammo Type", "Burst", "Damage Single", "Damage Burst", "Damage Auto", "Dir Up", "Dir Left", "Dir Down", "Dir Right", "Fire Freeze Single", "Fire Rate Single", "Fire Freeze Burst", "Fire Rate Burst", "Fire Freeze Auto", "Fire Rate Auto", "No-Fire Freeze", "No-Fire Rate", "Reload Freeze", "Reload Rate", "Random Single", "Random Burst", "Random Auto"};
  //temp.types = {"Gani"};
  new GuiWindowCtrl(GDBG_Window0)
  {
    canresize = canmaximize = false;
    
    profile = "GuiBlueWindowProfile";
    
    extent = {225, 65 + (25 * temp.types.size())};
    
    position = {0, 160};
    
    text = "Gun Debug: Arch -> None";
    
    for (temp.var: temp.types)
    {
      new GuiTextCtrl("GDBG_Text" @ temp.I)
      {
        profile = "GuiTextProfile";
      
        extent = {24, 20};
      
        position = {10, 30 + (25 * temp.I)};
      
        text = temp.var;
      }

      new GuiTextEditCtrl("GDBG_TextEdit" @ temp.I)
      {
        profile = "GuiBlueTextEditProfile";
      
        extent = {125, 20};
        position = {90, 30 + (25 * temp.I)};
      }
      
      temp.I++;
    }
    
    new GuiButtonCtrl(GDBG_Button0) {
      profile = "GuiBlueButtonProfile";
      
      extent = {65, 27};
      
      position = {10, GDBG_Window0.height - 36};
      
      text = "Close";
    }
    
    new GuiButtonCtrl(GDBG_Button1) {
      profile = "GuiBlueButtonProfile";
      
      extent = {65, 27};
      
      position = {80, GDBG_Window0.height - 36};
      
      text = "Load Arch";
    }
    
    new GuiButtonCtrl(GDBG_Button2)
    {
      profile = "GuiBlueButtonProfile";
      
      extent = {65, 27};
      
      position = {150, GDBG_Window0.height - 36};
      
      text = "Set Arch";
    }
  }
}

function GDBG_Button0.onAction()
{
  GDBG_Window0.destroy();
}

function GDBG_Button1.onAction()
{
  triggerserver("gui", this.name, "getarch", {GDBG_TextEdit.text});
}

function GDBG_Button2.onAction()
{
  setMudItem();
  
  for (temp.I = 0; temp.I < player.weapons.size(); temp.I++)
  {
    if (player.weapons[temp.I] == this.name)
    {
      selectedweapon = temp.I;
      
      break;
    }
  }
}

function setMudItem()
{
  this.muditem = new TStaticVar();
  
  this.muditem.damage  = {GDBG_TextEdit4.text, GDBG_TextEdit5.text, GDBG_TextEdit6.text};
  this.muditem.freeze  = {GDBG_TextEdit19.text, GDBG_TextEdit20.text, GDBG_TextEdit17.text, GDBG_TextEdit18.text};
  this.muditem.sfreeze = {{GDBG_TextEdit11.text, GDBG_TextEdit12.text}, {GDBG_TextEdit13.text, GDBG_TextEdit14.text}, {GDBG_TextEdit15.text, GDBG_TextEdit16.text}};
  this.muditem.loaded  = 0;
  this.muditem.gun     = {GDBG_TextEdit.text, GDBG_TextEdit2.text, GDBG_TextEdit1.text, GDBG_TextEdit3.text};
  this.muditem.gundir  = {{GDBG_TextEdit7.text}, {GDBG_TextEdit8.text}, {GDBG_TextEdit9.text}, {GDBG_TextEdit10.text}};
  this.muditem.gunrand = {{GDBG_TextEdit21.text}, {GDBG_TextEdit22.text}, {GDBG_TextEdit23.text}};
  
  this.compile = "";
  
  echo(this.muditem.sfreeze);
  
  this.compile.add("damage="  @ this.muditem.damage);
  this.compile.add("freeze="  @ this.muditem.freeze);
  this.compile.add("sfreeze=" @ this.muditem.sfreeze);
  this.compile.add("loaded="  @ this.muditem.loaded);
  this.compile.add("gun="     @ this.muditem.gun);
  this.compile.add("gundir="  @ this.muditem.gundir);
  this.compile.add("gunrand=" @ this.muditem.gunrand);
  
  this.compile.savelines("gundbug.txt", 0);
}